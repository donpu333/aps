<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Tools</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'JetBrains Mono', monospace;
            transition: margin-top 0.3s ease;
            background-color: #121212;
            color: #ffffff;
        }
        
        .nav-container {
            background: #1E1E1E;
            height: 25px;
            width: 100%;
            position: fixed;
            top: 0;
            z-index: 100;
            transition: height 0.3s ease;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            justify-content: flex-start;
            cursor: pointer;
        }
        
        .nav-container.expanded {
            height: 65px;
        }
        
        .nav-content {
            display: flex;
            gap: 1.5rem;
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            align-items: center;
            width: 100%;
        }
        
        .nav-container.expanded .nav-content {
            opacity: 1;
        }
        
        .nav-link {
            color: #ffffff;
            cursor: pointer;
            text-decoration: none;
            font-size: 1.1rem;
            padding: 0.6rem 1.2rem;
            transition: 0.2s;
            border-radius: 4px;
            white-space: nowrap;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .content-wrapper {
            margin-top: 25px;
            height: calc(100vh - 25px);
            transition: margin-top 0.3s ease;
        }
        
        .nav-container.expanded ~ .content-wrapper {
            margin-top: 65px;
            height: calc(100vh - 65px);
        }
        
        .menu-hint {
            color: #ffffff;
            padding: 0.3rem 1rem;
            font-size: 0.9rem;
            opacity: 0.7;
            pointer-events: none;
            transition: opacity 0.3s ease;
            align-self: center;
        }
        
        .nav-container.expanded .menu-hint {
            opacity: 0;
        }
        
        .auth-links {
            display: flex;
            gap: 1.5rem;
            margin-left: auto;
            align-items: center;
        }
        
        .auth-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.2s;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
        }
        
        .auth-btn:hover {
            background: #357abd;
        }
        
        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            z-index: 101;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            overflow: auto;
        }
        
        .modal-content {
            background-color: #1E1E1E;
            margin: 100px auto;
            padding: 25px;
            border-radius: 8px;
            width: 350px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .close-btn {
            color: #aaa;
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close-btn:hover {
            color: #fff;
        }
        
        .form-group {
            margin-bottom: 1.2rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.7rem;
            border-radius: 4px;
            border: 1px solid #333;
            background-color: #252525;
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
        }
        
        .form-actions {
            margin-top: 1.5rem;
        }
        
        .error-message {
            color: #ff4444;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            min-height: 20px;
        }
        
        .success-message {
            color: #00C851;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            min-height: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-email {
            color: #4285f4;
            font-weight: bold;
        }
        
        /* Анимация модального окна */
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-content {
            animation: modalFadeIn 0.3s ease-out;
        }
        
        /* Чекбокс "Запомнить меня" */
        .remember-me {
            display: flex;
            align-items: center;
            margin: 1rem 0;
        }
        
        .remember-me input {
            margin-right: 0.5rem;
        }
        
        /* Стили для вкладок */
        .tab-content {
            height: 100%;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .tab-pane {
            display: none;
            height: 100%;
            animation: fadeIn 0.3s ease-out;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.2rem;
        }
        
        .error {
            color: #ff4444;
            padding: 1rem;
            background: rgba(255, 68, 68, 0.1);
            border-radius: 4px;
        }
        
        .page-content {
            padding: 1rem;
        }
        
        .page-title {
            margin-top: 0;
            padding-bottom: 1rem;
            border-bottom: 1px solid #333;
        }
        
        /* Виджет */
        .widget-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
        
        .widget {
            background: #1E1E1E;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .widget-title {
            margin-top: 0;
            color: #4285f4;
        }

        /* Стили для калькулятора */
        .calculator-container {
            background-color: #1E1E1E;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(33, 150, 243, 0.2);
            margin-bottom: 20px;
        }
        
        .section {
            margin-bottom: 15px;
            padding: 12px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        .section-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #4285f4;
            font-size: 1rem;
        }
        
        .input-group {
            margin-bottom: 12px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #9CA3AF;
        }
        
        .input-group input[type="number"],
        .input-group input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: #2D2D2D;
            border: 1px solid #3D3D3D;
            color: white;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .input-group input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: #3D3D3D;
            border-radius: 3px;
            outline: none;
            margin: 10px 0;
        }
        
        .input-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4285f4;
            cursor: pointer;
        }
        
        .input-group input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4285f4;
            cursor: pointer;
        }
        
        .direction-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            background: #2A2A2A;
            padding: 5px;
            border-radius: 10px;
        }

        .direction-btn {
            flex: 1;
            padding: 10px 0;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
            position: relative;
            overflow: hidden;
        }

        .long {
            background: transparent;
            color: #A5D6A7;
        }

        .short {
            background: transparent;
            color: #EF9A9A;
        }

        .direction-btn.active {
            color: white;
        }

        .long.active {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
        }

        .short.active {
            background: linear-gradient(135deg, #F44336 0%, #C62828 100%);
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px;
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .result-value {
            font-weight: 500;
        }
        
        .profit {
            color: #03DAC6;
        }
        
        .loss {
            color: #C62828;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .slider-value {
            min-width: 30px;
            text-align: right;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .preview-value {
            color: #FFA000;
            font-size: 0.8rem;
            margin-top: 5px;
            padding: 4px;
            background-color: rgba(255, 160, 0, 0.1);
            border-radius: 4px;
        }
        
        .leverage-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .leverage-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: #4285f4;
            background-color: rgba(33, 150, 243, 0.1);
            padding: 4px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .leverage-warning {
            color: #C62828;
            font-size: 0.75rem;
            margin-top: 5px;
            padding: 4px;
            background-color: rgba(207, 102, 121, 0.1);
            border-radius: 4px;
            display: none;
        }
        
        .export-btn {
            width: 100%;
            padding: 10px 15px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 20px;
            text-align: center;
        }
        
        .export-btn:hover {
            background: #1976D2;
        }

        /* Стили для виджетов */
        .widget-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
        
        .widget {
            background: #1E1E1E;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .widget-title {
            margin-top: 0;
            color: #4285f4;
        }

        .calendar-container, .fear-greed-container {
            width: 100%;
        }

        .fear-greed-container {
            margin-top: 10px;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="nav-container" id="navContainer">
        <div class="menu-hint">Меню</div>
        <div class="nav-content">
            <div>
                <a class="nav-link" onclick="loadPage('calculator')">Калькулятор</a>
                <a class="nav-link" onclick="loadPage('widget')">Виджет</a>
            </div>
            <div class="auth-links" id="authLinks">
                <button class="auth-btn" onclick="showModal('loginModal')">Вход</button>
                <button class="auth-btn" onclick="showModal('registerModal')">Регистрация</button>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <span class="user-email" id="userEmail"></span>
                <button class="auth-btn" onclick="logout()">Выход</button>
            </div>
        </div>
    </nav>

    <div class="content-wrapper">
        <div class="tab-content">
            <div id="calculator" class="tab-pane active">
                <div class="calculator-container risk-calculator">
                    <h1>Калькулятор рисков</h1>
                    
                    <div class="section">
                        <div class="section-title">Параметры сделки</div>
                        
                        <div class="direction-buttons">
                            <button id="longBtn" class="direction-btn long active">Лонг</button>
                            <button id="shortBtn" class="direction-btn short">Шорт</button>
                        </div>
                        
                        <div class="input-group">
                            <label for="entryPrice">Цена входа (USDT)</label>
                            <input type="number" id="entryPrice" min="0" step="0.01" value="100.00">
                        </div>
                        
                        <div class="input-group">
                            <label for="leverage">Кредитное плечо</label>
                            <div class="leverage-container">
                                <input type="range" id="leverage" min="1" max="100" value="1">
                                <span class="leverage-value" id="leverageValue">1x</span>
                            </div>
                            <div class="leverage-warning" id="leverageWarning">
                                Высокое плечо увеличивает риск ликвидации!
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="atr">ATR (USDT)</label>
                            <input type="number" id="atr" min="0" step="0.01" value="5.00">
                            <div class="preview-value">
                                Размер ATR: <span id="atrValue">5.00 USDT</span>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="riskPercent">Риск стоп-лосс (% от ATR)</label>
                            <div class="slider-container">
                                <input type="range" id="riskPercent" min="1" max="100" value="50">
                                <span class="slider-value" id="riskPercentValue">50</span>%
                            </div>
                            <div class="preview-value">
                                Стоп-лосс: минус <span id="previewAtrPercent">2.50 USDT</span> (<span id="previewAtrPercentValue">50%</span> от ATR)
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="riskAmount">Риск на сделку (USDT)</label>
                            <input type="number" id="riskAmount" min="0" step="0.01" value="100.00">
                        </div>
                        
                        <div class="input-group">
                            <label for="rewardRatio">Соотношение тейк-профита (1:X)</label>
                            <div class="slider-container">
                                <input type="range" id="rewardRatio" min="3" max="20" value="3">
                                <span class="slider-value" id="rewardRatioValue">3</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">Результаты</div>
                        
                        <div class="result-item">
                            <span>Размер позиции:</span>
                            <span class="result-value" id="positionSize">40.0000</span>
                        </div>
                        
                        <div class="result-item">
                            <span>Стоп-лосс:</span>
                            <span class="result-value loss" id="stopLoss">97.50 USDT</span>
                        </div>
                        
                        <div class="result-item">
                            <span>Тейк-профит (1:<span id="currentRatio">3</span>):</span>
                            <span class="result-value profit" id="takeProfit">107.50 USDT</span>
                        </div>
                        
                        <div class="result-item">
                            <span>Потенциальная прибыль:</span>
                            <span class="result-value profit" id="potentialProfit">300.00 USDT</span>
                        </div>
                        
                        <div class="result-item">
                            <span>Цена ликвидации:</span>
                            <span class="result-value loss" id="liquidationPrice">95.00 USDT</span>
                        </div>
                    </div>
                    
                    <button class="export-btn" id="exportTextBtn">Экспорт в текст</button>
                </div>
                
                <!-- Average Calculator -->
                <div class="calculator-container average-calculator">
                    <h1>Калькулятор среднего</h1>
                    <div class="section">
                        <div class="input-group">
                            <label for="numbersInput">Введите числа через пробел:</label>
                            <input type="text" id="numbersInput" placeholder="5 10 15 20">
                        </div>
                        <button onclick="calculateAverage()" style="width: 100%; padding: 10px; background: #4285f4; border: none; border-radius: 5px; color: white; font-weight: 600;">Рассчитать</button>
                        <div id="result" style="margin-top: 15px;"></div>
                    </div>
                </div>
            </div>
            <div id="widget" class="tab-pane">
                <div class="widget-container">
                    <div class="widget">
                        <h3 class="widget-title">Курс BTC/USD</h3>
                        <div id="btc-widget">Загрузка данных...</div>
                    </div>
                    <div class="widget">
                        <h3 class="widget-title">Курс ETH/USD</h3>
                        <div id="eth-widget">Загрузка данных...</div>
                    </div>
                    <div class="widget calendar-container">
                        <div class="widget-title">Экономический календарь</div>
                        <iframe 
                            src="https://sslecal2.investing.com?columns=exc_flags,exc_currency,exc_importance,exc_actual,exc_forecast,exc_previous&importance=2,3&features=datepicker,timezone&countries=4,72,37,56,5&calType=week&timeZone=18&lang=7" 
                            width="100%" 
                            height="467" 
                            frameborder="0" 
                            allowtransparency="true" 
                            marginwidth="0" 
                            marginheight="0">
                        </iframe>
                        <div class="poweredBy" style="font-family: Arial, Helvetica, sans-serif;">
                            <span style="font-size: 11px;color: #333333;text-decoration: none;">
                                Экономический онлайн-календарь от 
                                <a href="https://ru.investing.com/" rel="nofollow" target="_blank" style="font-size: 11px;color: #06529D; font-weight: bold;" class="underline_link">Investing.com Россия</a>, ведущего финансового портала
                            </span>
                        </div>
                    </div>

                    <div class="widget fear-greed-container">
                        <div class="widget-title">Индекс страха и жадности</div>
                        <script async src="https://static.coinstats.app/widgets/v5/cs-widget.js"></script>
                        <fear-and-greed 
                            theme="dark"
                            direction="horizontal"
                            background="#0D0D0D"
                            is-market-sentiment-visible="true"
                            is-last-updated-visible="true"
                            title-color="#FFFFFF"
                            chart-indicator-one-color="#F02935"
                            chart-indicator-two-color="#F07D29"
                            chart-indicator-three-color="#9ACB82"
                            chart-indicator-four-color="#34B349"
                            subtitle-color="#999999"
                            last-updated-color="#999999"
                            arrow-color="#262626">
                        </fear-and-greed>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно входа -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="hideModal('loginModal')">&times;</span>
            <h2>Вход</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required placeholder="Ваш email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Пароль</label>
                    <input type="password" id="loginPassword" required placeholder="Ваш пароль">
                </div>
                <div class="remember-me">
                    <input type="checkbox" id="rememberMe" checked>
                    <label for="rememberMe">Запомнить меня</label>
                </div>
                <div class="error-message" id="loginError"></div>
                <div class="form-actions">
                    <button type="button" class="auth-btn" onclick="login()">Войти</button>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <a href="#" onclick="showForgotPassword()" style="color: #4285f4; font-size: 0.9rem;">Забыли пароль?</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно регистрации -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="hideModal('registerModal')">&times;</span>
            <h2>Регистрация</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label for="registerUsername">Имя пользователя</label>
                    <input type="text" id="registerUsername" required placeholder="Придумайте логин">
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" required placeholder="Ваш email">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Пароль</label>
                    <input type="password" id="registerPassword" required placeholder="Не менее 6 символов">
                </div>
                <div class="form-group">
                    <label for="registerConfirmPassword">Подтвердите пароль</label>
                    <input type="password" id="registerConfirmPassword" required placeholder="Повторите пароль">
                </div>
                <div class="error-message" id="registerError"></div>
                <div class="success-message" id="registerSuccess"></div>
                <div class="form-actions">
                    <button type="button" class="auth-btn" onclick="register()">Зарегистрироваться</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно восстановления пароля -->
    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="hideModal('forgotPasswordModal')">&times;</span>
            <h2>Восстановление пароля</h2>
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label for="forgotEmail">Email</label>
                    <input type="email" id="forgotEmail" required placeholder="Ваш email">
                </div>
                <div class="error-message" id="forgotError"></div>
                <div class="success-message" id="forgotSuccess"></div>
                <div class="form-actions">
                    <button type="button" class="auth-btn" onclick="sendResetLink()">Отправить ссылку</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Состояние приложения
        const state = {
            currentUser: null,
            settings: {},
            pageCache: {}
        };

        // DOM элементы
        const navContainer = document.getElementById('navContainer');
        const authLinks = document.getElementById('authLinks');
        const userInfo = document.getElementById('userInfo');
        const userEmail = document.getElementById('userEmail');
        
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            // Проверяем авторизацию в localStorage
            const savedUser = localStorage.getItem('cryptoAppUser');
            const savedSettings = localStorage.getItem('cryptoAppSettings');
            
            if (savedUser) {
                state.currentUser = JSON.parse(savedUser);
                if (savedSettings) {
                    state.settings = JSON.parse(savedSettings);
                }
                updateUI();
            }
            
            // Загружаем начальную страницу
            const initialPage = state.currentUser ? state.settings.lastPage || 'calculator' : 'calculator';
            loadPage(initialPage);
            
            // Проверяем "Запомнить меня"
            checkRememberMe();
            
            // Загружаем данные для виджета
            loadWidgetData();

            // Инициализация калькулятора рисков
            initRiskCalculator();
        });


        // Функции для работы с модальными окнами
        function showModal(id) {
            document.getElementById(id).style.display = 'block';
            // Очищаем сообщения при открытии
            if (id === 'registerModal') {
                document.getElementById('registerError').textContent = '';
                document.getElementById('registerSuccess').textContent = '';
                document.getElementById('registerForm').reset();
            } else if (id === 'loginModal') {
                document.getElementById('loginError').textContent = '';
                document.getElementById('loginForm').reset();
            } else if (id === 'forgotPasswordModal') {
                document.getElementById('forgotError').textContent = '';
                document.getElementById('forgotSuccess').textContent = '';
                document.getElementById('forgotPasswordForm').reset();
            }
        }
        
        function hideModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        function showForgotPassword() {
            hideModal('loginModal');
            showModal('forgotPasswordModal');
        }

        // Хеширование пароля (упрощенное для демонстрации)
        function hashPassword(password) {
            return btoa(unescape(encodeURIComponent(password))); // В реальном приложении используйте более надежное хеширование
        }

        // Регистрация нового пользователя
        function register() {
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const errorElement = document.getElementById('registerError');
            const successElement = document.getElementById('registerSuccess');
            
            // Валидация
            if (!username || !email || !password || !confirmPassword) {
                errorElement.textContent = 'Все поля обязательны для заполнения';
                return;
            }
            
            if (password !== confirmPassword) {
                errorElement.textContent = 'Пароли не совпадают';
                return;
            }
            
            if (password.length < 6) {
                errorElement.textContent = 'Пароль должен содержать минимум 6 символов';
                return;
            }
            
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                errorElement.textContent = 'Введите корректный email';
                return;
            }
            
            // Проверяем, есть ли уже такой пользователь
            const users = JSON.parse(localStorage.getItem('cryptoAppUsers')) || {};
            if (users[email]) {
                errorElement.textContent = 'Пользователь с таким email уже существует';
                return;
            }
            
            // Регистрируем пользователя
            users[email] = { 
                username,
                email, 
                password: hashPassword(password),
                createdAt: new Date().toISOString(),
                isVerified: false,
                verifyToken: Math.random().toString(36).substring(2, 15)
            };
            localStorage.setItem('cryptoAppUsers', JSON.stringify(users));
            
            // Показываем сообщение об успехе
            errorElement.textContent = '';
            successElement.textContent = 'Регистрация прошла успешно!';
            
            // Автоматически входим через 1.5 секунды
            setTimeout(() => {
                state.currentUser = { username, email };
                localStorage.setItem('cryptoAppUser', JSON.stringify(state.currentUser));
                
                // Создаем настройки по умолчанию
                state.settings = {
                    theme: 'dark',
                    lastPage: 'calculator',
                    alerts: []
                };
                localStorage.setItem('cryptoAppSettings', JSON.stringify(state.settings));
                
                updateUI();
                hideModal('registerModal');
                loadPage(state.settings.lastPage);
            }, 1500);
        }

        // Вход пользователя
        function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const remember = document.getElementById('rememberMe').checked;
            const errorElement = document.getElementById('loginError');
            
            // Проверяем пользователя
            const users = JSON.parse(localStorage.getItem('cryptoAppUsers')) || {};
            const user = users[email];
            
            if (!user || user.password !== hashPassword(password)) {
                errorElement.textContent = 'Неверный email или пароль';
                return;
            }
            
            if (!user.isVerified) {
                errorElement.textContent = 'Подтвердите почту!';
                return;
            }
            
            // Входим
            state.currentUser = { username: user.username, email };
            localStorage.setItem('cryptoAppUser', JSON.stringify(state.currentUser));
            
            // Загружаем настройки
            const allSettings = JSON.parse(localStorage.getItem('cryptoAppAllSettings')) || {};
            state.settings = allSettings[email] || {
                theme: 'dark',
                lastPage: 'calculator',
                alerts: []
            };
            
            if (remember) {
                const rememberToken = Math.random().toString(36).substring(2, 15);
                user.rememberToken = hashPassword(rememberToken);
                localStorage.setItem('cryptoAppUsers', JSON.stringify(users));
                
                // Устанавливаем куку на 30 дней
                const date = new Date();
                date.setTime(date.getTime() + (30 * 24 * 60 * 60 * 1000));
                document.cookie = `remember=${rememberToken}; expires=${date.toUTCString()}; path=/`;
            }
            
            updateUI();
            hideModal('loginModal');
            loadPage(state.settings.lastPage);
        }

        // Отправка ссылки для сброса пароля
        function sendResetLink() {
            const email = document.getElementById('forgotEmail').value.trim();
            const errorElement = document.getElementById('forgotError');
            const successElement = document.getElementById('forgotSuccess');
            
            if (!email) {
                errorElement.textContent = 'Введите email';
                return;
            }
            
            // Проверяем существование пользователя
            const users = JSON.parse(localStorage.getItem('cryptoAppUsers')) || {};
            const user = users[email];
            
            if (!user) {
                errorElement.textContent = 'Пользователь с таким email не найден';
                return;
            }
            
            // Генерируем токен сброса
            user.resetToken = Math.random().toString(36).substring(2, 15);
            user.resetTokenExpires = new Date(Date.now() + 3600000).toISOString(); // 1 час
            localStorage.setItem('cryptoAppUsers', JSON.stringify(users));
            
            errorElement.textContent = '';
            successElement.textContent = 'Ссылка для сброса пароля отправлена на ваш email';
            
            console.log(`Ссылка для сброса пароля: https://yourdomain.com/reset_password.html?token=${user.resetToken}&email=${encodeURIComponent(email)}`);
        }

        // Выход пользователя
        function logout() {
            state.currentUser = null;
            localStorage.removeItem('cryptoAppUser');
            
            // Удаляем куку "Запомнить меня"
            document.cookie = 'remember=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            
            updateUI();
            loadPage('calculator');
        }

        // Обновление интерфейса
        function updateUI() {
            if (state.currentUser) {
                authLinks.style.display = 'none';
                userInfo.style.display = 'flex';
                userEmail.textContent = state.currentUser.username || state.currentUser.email;
                
                // Применяем настройки
                document.body.style.backgroundColor = state.settings.theme === 'dark' ? '#121212' : '#f5f5f5';
                document.body.style.color = state.settings.theme === 'dark' ? '#ffffff' : '#000000';
            } else {
                authLinks.style.display = 'flex';
                userInfo.style.display = 'none';
            }
        }

        // Загрузка страницы
        function loadPage(page) {
            // Скрываем все вкладки
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            
            // Показываем выбранную вкладку
            const activeTab = document.getElementById(page);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.display = 'block';
                
                // Для виджета обновляем данные
                if (page === 'widget') {
                    loadWidgetData();
                }
            }
            
            // Сворачиваем меню
            navContainer.classList.remove('expanded');
            
            // Сохраняем последнюю страницу в настройках
            if (state.currentUser) {
                state.settings.lastPage = page;
                const allSettings = JSON.parse(localStorage.getItem('cryptoAppAllSettings')) || {};
                allSettings[state.currentUser.email] = state.settings;
                localStorage.setItem('cryptoAppAllSettings', JSON.stringify(allSettings));
            }
        }

        // Открытие/закрытие меню по клику
        navContainer.addEventListener('click', function(e) {
            if (e.target === navContainer) {
                navContainer.classList.toggle('expanded');
            }
        });
        
        // Закрытие модальных окон при клике вне их области
        window.addEventListener('click', function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        });
        
        // Проверка куки "Запомнить меня" при загрузке
        function checkRememberMe() {
            const cookies = document.cookie.split(';');
            let rememberToken = null;
            
            for (const cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'remember') {
                    rememberToken = value;
                    break;
                }
            }
            
            if (rememberToken) {
                const users = JSON.parse(localStorage.getItem('cryptoAppUsers')) || {};
                
                for (const email in users) {
                    const user = users[email];
                    if (user.rememberToken && user.rememberToken === hashPassword(rememberToken)) {
                        state.currentUser = { username: user.username, email };
                        localStorage.setItem('cryptoAppUser', JSON.stringify(state.currentUser));
                        
                        // Загружаем настройки
                        const allSettings = JSON.parse(localStorage.getItem('cryptoAppAllSettings')) || {};
                        state.settings = allSettings[email] || {
                            theme: 'dark',
                            lastPage: 'calculator',
                            alerts: []
                        };
                        
                        updateUI();
                        loadPage(state.settings.lastPage);
                        break;
                    }
                }
            }
        }

        // Функции для калькулятора рисков
        function initRiskCalculator() {
            // Элементы интерфейса
            const longBtn = document.getElementById('longBtn');
            const shortBtn = document.getElementById('shortBtn');
            const entryPriceInput = document.getElementById('entryPrice');
            const leverageInput = document.getElementById('leverage');
            const leverageValue = document.getElementById('leverageValue');
            const leverageWarning = document.getElementById('leverageWarning');
            const atrInput = document.getElementById('atr');
            const riskPercentInput = document.getElementById('riskPercent');
            const riskPercentValue = document.getElementById('riskPercentValue');
            const riskAmountInput = document.getElementById('riskAmount');
            const rewardRatioInput = document.getElementById('rewardRatio');
            const rewardRatioValue = document.getElementById('rewardRatioValue');
            const currentRatioSpan = document.getElementById('currentRatio');
            const atrValueSpan = document.getElementById('atrValue');
            const previewAtrPercent = document.getElementById('previewAtrPercent');
            const previewAtrPercentValue = document.getElementById('previewAtrPercentValue');
            
            // Элементы результатов
            const positionSizeSpan = document.getElementById('positionSize');
            const stopLossSpan = document.getElementById('stopLoss');
            const takeProfitSpan = document.getElementById('takeProfit');
            const potentialProfitSpan = document.getElementById('potentialProfit');
            const liquidationPriceSpan = document.getElementById('liquidationPrice');
            
            // Переменные состояния
            let isLong = true;
            
            // Инициализация
            function init() {
                updateSliderValues();
                updateAtrPreview();
                calculateRisk();
                
                // Назначение обработчиков событий
                longBtn.addEventListener('click', () => {
                    isLong = true;
                    longBtn.classList.add('active');
                    shortBtn.classList.remove('active');
                    calculateRisk();
                });
                
                shortBtn.addEventListener('click', () => {
                    isLong = false;
                    shortBtn.classList.add('active');
                    longBtn.classList.remove('active');
                    calculateRisk();
                });
                
                entryPriceInput.addEventListener('input', calculateRisk);
                leverageInput.addEventListener('input', () => {
                    leverageValue.textContent = leverageInput.value + 'x';
                    if (leverageInput.value > 10) {
                        leverageWarning.style.display = 'block';
                    } else {
                        leverageWarning.style.display = 'none';
                    }
                    calculateRisk();
                });
                atrInput.addEventListener('input', () => {
                    updateAtrPreview();
                    calculateRisk();
                });
                riskPercentInput.addEventListener('input', () => {
                    updateSliderValues();
                    updateAtrPreview();
                    calculateRisk();
                });
                riskAmountInput.addEventListener('input', calculateRisk);
                rewardRatioInput.addEventListener('input', () => {
                    updateSliderValues();
                    calculateRisk();
                });
                
                // Инициализация кнопки экспорта
                document.getElementById('exportTextBtn').addEventListener('click', exportToText);
            }
            
            // Обновление значений слайдеров
            function updateSliderValues() {
                riskPercentValue.textContent = riskPercentInput.value;
                rewardRatioValue.textContent = rewardRatioInput.value;
                currentRatioSpan.textContent = rewardRatioInput.value;
                previewAtrPercentValue.textContent = riskPercentInput.value + '%';
            }
            
            // Предварительный просмотр ATR
            function updateAtrPreview() {
                const atr = parseFloat(atrInput.value) || 0;
                const riskPercent = parseFloat(riskPercentInput.value) / 100;
                
                atrValueSpan.textContent = atr.toFixed(2) + ' USDT';
                previewAtrPercent.textContent = (atr * riskPercent).toFixed(2) + ' USDT';
            }
            
            // Расчет цены ликвидации
            function calculateLiquidationPrice(entryPrice, leverage, isLong) {
                if (isLong) {
                    return entryPrice * (1 - (1 / leverage));
                } else {
                    return entryPrice * (1 + (1 / leverage));
                }
            }
            
            // Основная функция расчета
            function calculateRisk() {
                const entryPrice = parseFloat(entryPriceInput.value) || 0;
                const leverage = parseFloat(leverageInput.value) || 1;
                const atr = parseFloat(atrInput.value) || 0;
                const riskPercent = parseFloat(riskPercentInput.value) / 100;
                const riskAmount = parseFloat(riskAmountInput.value) || 0;
                const rewardRatio = parseFloat(rewardRatioInput.value) || 3;
                
                // Расчет стоп-лосса
                let stopLossPrice;
                if (isLong) {
                    stopLossPrice = entryPrice - (atr * riskPercent);
                } else {
                    stopLossPrice = entryPrice + (atr * riskPercent);
                }
                
                // Расчет размера позиции с учетом плеча
                const priceDifference = Math.abs(entryPrice - stopLossPrice);
                const positionSize = priceDifference > 0 ? (riskAmount / priceDifference) * leverage : 0;
                
                // Расчет тейк-профита
                let takeProfitPrice;
                if (isLong) {
                    takeProfitPrice = entryPrice + (priceDifference * rewardRatio);
                } else {
                    takeProfitPrice = entryPrice - (priceDifference * rewardRatio);
                }
                
                // Расчет потенциальной прибыли с учетом плеча
                const potentialProfit = (positionSize / leverage) * Math.abs(takeProfitPrice - entryPrice);
                
                // Расчет цены ликвидации
                const liquidationPrice = calculateLiquidationPrice(entryPrice, leverage, isLong);
                
                // Обновление интерфейса
                positionSizeSpan.textContent = positionSize.toFixed(4);
                stopLossSpan.textContent = `${stopLossPrice.toFixed(2)} USDT`;
                takeProfitSpan.textContent = `${takeProfitPrice.toFixed(2)} USDT`;
                potentialProfitSpan.textContent = `${potentialProfit.toFixed(2)} USDT`;
                liquidationPriceSpan.textContent = `${liquidationPrice.toFixed(2)} USDT`;
            }
            
            // Экспорт в текстовый файл
            function exportToText() {
                const content = `
Калькулятор рисков - Результаты
===============================
Дата: ${new Date().toLocaleString()}
Направление: ${isLong ? 'Лонг' : 'Шорт'}

Параметры сделки:
-----------------
Цена входа: ${entryPriceInput.value} USDT
Кредитное плечо: ${leverageInput.value}x
ATR: ${atrInput.value} USDT
Риск стоп-лосс: ${riskPercentInput.value}% от ATR
Риск на сделку: ${riskAmountInput.value} USDT
Соотношение тейк-профита: 1:${rewardRatioInput.value}

Результаты:
-----------
Размер позиции: ${positionSizeSpan.textContent}
Стоп-лосс: ${stopLossSpan.textContent}
Тейк-профит (1:${rewardRatioInput.value}): ${takeProfitSpan.textContent}
Потенциальная прибыль: ${potentialProfitSpan.textContent}
Цена ликвидации: ${liquidationPriceSpan.textContent}
                `;
                
                const blob = new Blob([content], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'расчет_рисков.txt';
                a.click();
                URL.revokeObjectURL(url);
            }
            
            // Запуск приложения
            init();
        }

        // Функция для калькулятора среднего
        function calculateAverage() {
            const input = document.getElementById('numbersInput').value.trim();
            const resultDiv = document.getElementById('result');
            
            if (!input) {
                resultDiv.innerHTML = '<p style="color: #F44336;">Введите числа!</p>';
                return;
            }

            let numbers;
            try {
                numbers = input.split(' ').map(num => parseFloat(num));
                if (numbers.some(isNaN)) {
                    throw new Error();
                }
            } catch {
                resultDiv.innerHTML = '<p style="color: #F44336;">Ошибка: вводите только числа, разделённые пробелами!</p>';
                return;
            }

            const sum = numbers.reduce((sum, num) => sum + num, 0);
            const count = numbers.length;
            const mean = sum / count;
            const deviations = numbers.map(num => num - mean);

            resultDiv.innerHTML = `
                <div style="background: rgba(30,30,30,0.5); padding: 10px; border-radius: 5px;">
                    <p><strong>Чисел:</strong> ${count}</p>
                    <p><strong>Сумма:</strong> ${sum.toFixed(2)}</p>
                    <p><strong>Среднее:</strong> ${mean.toFixed(2)}</p>
                    <p><strong>Отклонения:</strong></p>
                    <ul style="padding-left: 20px;">
                        ${numbers.map((num, i) => 
                            `<li>${num} - ${mean.toFixed(2)} = ${deviations[i].toFixed(2)}</li>`
                        ).join('')}
                    </ul>
                </div>
            `;
        }
    </script>
</body>
</html>
